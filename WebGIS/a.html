<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>中博宇图</title>
    <link rel="stylesheet" href="http://localhost/arcgis_js_api/library/3.25/dijit/themes/tundra/tundra.css">
    <link rel="stylesheet" type="text/css" href="http://localhost/arcgis_js_api/library/3.25/esri/css/esri.css" />
    <script type="text/javascript" src="http://localhost/arcgis_js_api/library/3.25/init.js"></script>
    <style type="text/css">
        * {
            margin: 0px;
            padding: 0px;
        }
        
        html,
        body {
            height: 100%;
            width: 100%;
            position: relative;
            overflow: hidden;
        }
    </style>

</head>

<body class="tundra">
    <input type="button" name="name" id="analyse" value="开启叠加分析" style="position: absolute; right: 10px; top: 20px; border: 1px solid #9c9c9c; background: #fff; width: 100px; height: auto; z-index: 99;padding: 10px;" />
    <input type="button" name="name" id="pygon" value="圈定范围 " style="position: absolute; right: 10px; top: 70px; border: 1px solid #9c9c9c; background: #fff; width: 100px; height: auto; z-index: 99;padding: 10px;" />
    <input type="button" name="name" id="line" value="测算距离" style="position: absolute; right: 10px; top: 120px; border: 1px solid #9c9c9c; background: #fff; width: 100px; height: auto; z-index: 99;padding: 10px;">
    <input type="button" name="name" id="ploygon" value="测算面积" style="position: absolute; right: 10px; top: 170px; border: 1px solid #9c9c9c; background: #fff; width: 100px; height: auto; z-index: 99;padding: 10px;">
    <input type="button" name="name" id="putout" value="导出汇总数据" style="position: absolute; right: 10px; top: 220px; border: 1px solid #9c9c9c; background: #fff; width: 100px; height: auto; z-index: 99;padding: 10px;">
    <input type="button" name="name" id="close" value="清除" style="position: absolute; right: 10px; top: 270px; border: 1px solid #9c9c9c; background: #fff; width: 100px; height: auto; z-index: 99;padding: 10px;">
    <input type="text" placeholder="0~100" id="opacity" value="" style="position: absolute; right: 115px; bottom: 20px; border: 1px solid #9c9c9c; background: #fff; width: 70px; height: auto; z-index: 99;padding: 5px;" />
    <input type="button" name="name" id="setOpacity" value="更改透明度" style="position: absolute; right: 10px; bottom: 20px; border: 1px solid #9c9c9c; background: #fff; width: 100px; height: auto;z-index: 99;padding: 5px;" />
    <div id="mapDiv" style="float:left;width: 100%;height: 100%;">
        <div class="dropdown" style="position: absolute; text-align: center; bottom: 0px; border: 1px solid #9c9c9c; background: #fff; width: 140px; height: auto;z-index:99;padding: 5px;">
            底图
            <div class="dropdown-content">
                <input type="checkbox" a url="http://192.168.100.195:6080/arcgis/rest/services/DLTB2020/MapServer"> DLTB2020

                <input type="checkbox" a url="http://192.168.100.195:6080/arcgis/rest/services/DLTB2018/MapServer"> DLTB2018

                <input type="checkbox" a url="http://192.168.100.195:6080/arcgis/rest/services/DLTB2017/MapServer"> DLTB2017

                <input type="checkbox" a url="http://192.168.100.195:6080/arcgis/rest/services/济源正射/MapServer"> 济源市正射

                <input type="checkbox" a url="http://192.168.100.195:6080/arcgis/rest/services/经营权_北海/MapServer"> 经营权-北海

                <input type="checkbox" a url="http://192.168.100.195:6080/arcgis/rest/services/经营权_克井/MapServer"> 经营权-克井

                <input type="checkbox" a url="http://192.168.100.195:6080/arcgis/rest/services/经营权_大峪/MapServer"> 经营权-大峪

                <input type="checkbox" a url="http://192.168.100.195:6080/arcgis/rest/services/经营权_承留/MapServer"> 经营权-承留

                <input type="checkbox" a url="http://192.168.100.195:6080/arcgis/rest/services/经营权_梨林/MapServer"> 经营权-梨林

                <input type="checkbox" a url="http://192.168.100.195:6080/arcgis/rest/services/经营权_坡头/MapServer"> 经营权-坡头

                <input type="checkbox" a url="http://192.168.100.195:6080/arcgis/rest/services/经营权_沁园/MapServer"> 经营权-沁园

                <input type="checkbox" a url="http://192.168.100.195:6080/arcgis/rest/services/经营权_邵原/MapServer"> 经营权-邵原

                <input type="checkbox" a url="http://192.168.100.195:6080/arcgis/rest/services/经营权_天坛/MapServer"> 经营权-天坛

                <input type="checkbox" a url="http://192.168.100.195:6080/arcgis/rest/services/经营权_王屋/MapServer"> 经营权-王屋

                <input type="checkbox" a url="http://192.168.100.195:6080/arcgis/rest/services/经营权_下冶/MapServer"> 经营权-下冶

                <input type="checkbox" a url="http://192.168.100.195:6080/arcgis/rest/services/经营权_五龙口/MapServer"> 经营权-五龙

                <input type="checkbox" a url="http://192.168.100.195:6080/arcgis/rest/services/经营权_轵城/MapServer"> 经营权-轵城

                <input type="checkbox" a url="http://192.168.100.195:6080/arcgis/rest/services/经营权_玉泉/MapServer"> 经营权-玉泉

                <input type="checkbox" a url="http://192.168.100.195:6080/arcgis/rest/services/经营权_思礼/MapServer"> 经营权-思礼

            </div>
            <style>
                /* 容器 <div> - 需要定位下拉内容 */
                
                .dropdown {
                    position: absolute;
                    display: inline-block;
                }
                /*.dropdown-content 类中是实际的下拉菜单。默认是隐藏的*/
                /*鼠标移动到指定元素后会显示*/
                /*想设置下拉内容与下拉按钮的宽度一致，可设置 width 为 100%
        
        overflow:auto 设置可以在小尺寸屏幕上滚动
        
        box-shadow 属性让下拉菜单看起来像一个"卡片"
        
        :hover 选择器用于在用户将鼠标移动到下拉按钮上时显示下拉菜单*/
                /* 下拉内容 (默认隐藏) */
                
                .dropdown-content {
                    display: none;
                    position: absolute;
                    left: 0px;
                    background-color: #eef4f7;
                    min-width: 0px;
                    padding: 0px 13px;
                }
                /* 下拉菜单的链接 */
                
                .dropdown-content a {
                    color: black;
                    padding: 0px 0px;
                    left: 5px;
                    text-decoration: none;
                    display: block;
                }
                /* 下拉按钮样式 */
                
                .dropbtn {
                    color: white;
                    width: 140px;
                }
                /*鼠标移上去后显示的下拉菜单的颜色*/
                
                .dropdown-content a:hover {
                    background-color: #f0f2f3;
                }
                /*鼠标移上去后显示下拉菜单*/
                
                .dropdown:hover .dropdown-content {
                    display: block;
                    margin-top: -400px;
                    width: 140px;
                }
            </style>
        </div>
    </div>
    <script type="text/javascript">
        require([
            'dojo/on',
            "dojo/dom",
            "dojo/dom-attr",
            "dojo/_base/declare",
            "dojo/_base/lang",
            "dojo/_base/array",
            'esri/map',
            'esri/layers/ArcGISDynamicMapServiceLayer',
            "dojo/_base/xhr",
            "esri/InfoTemplate",
            "esri/dijit/InfoWindow",
            "esri/tasks/IdentifyTask",
            "esri/tasks/IdentifyParameters",
            "esri/tasks/IdentifyResult",
            "esri/tasks/QueryTask",
            "esri/tasks/query",
            "esri/tasks/FeatureSet",
            "dojox/collections/Dictionary",
            "dojo/data/ItemFileReadStore",
            "dijit/tree/ForestStoreModel",
            "dijit/Tree",
            "esri/geometry/Polyline",
            "esri/geometry/Polygon",
            "esri/geometry/geometryEngine",
            "esri/symbols/SimpleMarkerSymbol",
            "esri/symbols/SimpleLineSymbol",
            "esri/symbols/SimpleFillSymbol",
            "esri/symbols/TextSymbol",
            "esri/Color",
            "esri/graphic",
            "esri/toolbars/draw",
            "esri/symbols/Font",
        ], function(
            on,
            dom,
            domAttr,
            declare,
            lang,
            arrayUtil,
            Map,
            ArcGISDynamicMapServiceLayer,
            xhr,
            InfoTemplate,
            InfoWindow,
            IdentifyTask,
            IdentifyParameters,
            IdentifyResult,
            QueryTask,
            Query,
            FeatureSet,
            Dictionary,
            ItemFileReadStore,
            ForestStoreModel,
            Tree,
            Polyline,
            Polygon,
            geometryEngine,
            SimpleMarkerSymbol,
            SimpleLineSymbol,
            SimpleFillSymbol,
            TextSymbol,
            Color,
            Graphic,
            Draw,
            Font
        ) {
            var map = new Map("mapDiv", {
                logo: false,

            });
            var draw = new Draw(map);
            var dylayer = new ArcGISDynamicMapServiceLayer("http://192.168.100.195:6080/arcgis/rest/services/jy/MapServer");
            map.addLayer(dylayer);
            var dylayer16 = new ArcGISDynamicMapServiceLayer("http://192.168.100.195:6080/arcgis/rest/services/五龙口镇/MapServer");
            map.addLayer(dylayer16);
            var dylayer17 = new ArcGISDynamicMapServiceLayer("http://192.168.100.195:6080/arcgis/rest/services/克井镇/MapServer");
            map.addLayer(dylayer17);
            var dylayer18 = new ArcGISDynamicMapServiceLayer("http://192.168.100.195:6080/arcgis/rest/services/坡头镇/MapServer");
            map.addLayer(dylayer18);
            var dylayer19 = new ArcGISDynamicMapServiceLayer("http://192.168.100.195:6080/arcgis/rest/services/大峪镇/MapServer");
            map.addLayer(dylayer19);
            var dylayer20 = new ArcGISDynamicMapServiceLayer("http://192.168.100.195:6080/arcgis/rest/services/思礼镇/MapServer");
            map.addLayer(dylayer20);
            var dylayer21 = new ArcGISDynamicMapServiceLayer("http://192.168.100.195:6080/arcgis/rest/services/承留镇/MapServer");
            map.addLayer(dylayer21);
            var dylayer22 = new ArcGISDynamicMapServiceLayer("http://192.168.100.195:6080/arcgis/rest/services/梨林镇2000/MapServer");
            map.addLayer(dylayer22);
            var dylayer23 = new ArcGISDynamicMapServiceLayer("http://192.168.100.195:6080/arcgis/rest/services/邵原镇/MapServer");
            map.addLayer(dylayer23);
            var clickQuery, _clickUrl, _clickTree;
            var _clickIds;
            var isanalyse = false;
            var isline = false;
            var isploygon = false;
            var _evt;
            var evtArray = new Array();
            var queryUrl = "none";
            var shapeArr = new Array();
            var shapeList = new Array();
            var layer1 = {
                url: "http://192.168.100.195:6080/arcgis/rest/services/DLTB2020/MapServer",
                id: "DLTB2020",
                name: "DLTB2020"
            };
            var layer2 = {
                url: "http://192.168.100.195:6080/arcgis/rest/services/DLTB2018/MapServer",
                id: "DLTB2018",
                name: "DLTB2018"
            };
            var layer3 = {
                url: "http://192.168.100.195:6080/arcgis/rest/services/DLTB2017/MapServer",
                id: "DLTB2007",
                name: "DLTB2007"
            };
            var layer4 = {
                url: "http://192.168.100.195:6080/arcgis/rest/services/济源正射/MapServer",
                id: "zs",
                name: "济源正射"
            };
            var layer5 = {
                url: "http://192.168.100.195:6080/arcgis/rest/services/经营权_北海/MapServer",
                id: "jyq_bh",
                name: "经营权_北海"
            }
            var layer6 = {
                url: "http://192.168.100.195:6080/arcgis/rest/services/经营权_克井/MapServer",
                id: "jyq_kj",
                name: "经营权_克井"
            }
            var layer7 = {
                url: "http://192.168.100.195:6080/arcgis/rest/services/经营权_大峪/MapServer",
                id: "jyq_dy",
                name: "经营权_大峪"
            }
            var layer8 = {
                url: "http://192.168.100.195:6080/arcgis/rest/services/经营权_承留/MapServer",
                id: "jyq_cl",
                name: "经营权_承留"
            }
            var layer9 = {
                url: "http://192.168.100.195:6080/arcgis/rest/services/经营权_梨林/MapServer",
                id: "jyq_ll",
                name: "经营权_梨林"
            }
            var layer10 = {
                url: "http://192.168.100.195:6080/arcgis/rest/services/经营权_坡头/MapServer",
                id: "jyq_pt",
                name: "经营权_坡头"
            }
            var layer11 = {
                url: "http://192.168.100.195:6080/arcgis/rest/services/经营权_沁园/MapServer",
                id: "jyq_qy",
                name: "经营权_沁园"
            }
            var layer12 = {
                url: "http://192.168.100.195:6080/arcgis/rest/services/经营权_邵原/MapServer",
                id: "jyq_sy",
                name: "经营权_邵原"
            }
            var layer13 = {
                url: "http://192.168.100.195:6080/arcgis/rest/services/经营权_天坛/MapServer",
                id: "jyq_tt",
                name: "经营权_天坛"
            }
            var layer14 = {
                url: "http://192.168.100.195:6080/arcgis/rest/services/经营权_王屋/MapServer",
                id: "jyq_ww",
                name: "经营权_王屋"
            }
            var layer15 = {
                url: "http://192.168.100.195:6080/arcgis/rest/services/经营权_下冶/MapServer",
                id: "jyq_xy",
                name: "经营权_下冶"
            }
            var layer16 = {
                url: "http://192.168.100.195:6080/arcgis/rest/services/经营权_五龙口/MapServer",
                id: "jyq_wlk",
                name: "经营权_五龙口"
            }
            var layer17 = {
                url: "http://192.168.100.195:6080/arcgis/rest/services/经营权_轵城/MapServer",
                id: "jyq_zz",
                name: "经营权_轵城"
            }

            var layers = [layer1, layer2, layer3, layer4, layer5, layer6, layer7, layer8, layer9, layer10, layer11, layer12, layer13, layer14, layer15, layer16, layer17, layer18, layer19];
            var html = "";
            for (var i = 0, length = layers.length; i < length; i++) {
                var layer = layers[i];
                html = html + "<div><input id='" + layer.id + "' name='layerList' class='listCss' type='checkbox' value='checkbox' onclick='setLayerVisibility()' " + (false ? "checked" : "") + " />" + layer.name + "</div>";
            }
            dojo.byId("toc").innerHTML = html;

            var loadLayer1 = new ArcGISDynamicMapServiceLayer("http://192.168.100.195:6080/arcgis/rest/services/DLTB2020/MapServer");
            var btn1 = document.getElementById("DLTB2020");
            btn1.onclick = function() {
                if (btn1.checked) {
                    map.addLayer(loadLayer1);
                    shapeArr.push("2020");
                } else {
                    map.removeLayer(loadLayer1);
                    shapeArr.remove("2020");
                }
                toplayer();
            }

            var loadLayer2 = new ArcGISDynamicMapServiceLayer("http://192.168.100.195:6080/arcgis/rest/services/DLTB2018/MapServer");
            var btn2 = document.getElementById("DLTB2018");
            btn2.onclick = function() {
                if (btn2.checked) {
                    map.addLayer(loadLayer2);
                    shapeArr.push("2018");
                } else {
                    map.removeLayer(loadLayer2);
                    shapeArr.remove("2018");
                }
                toplayer();
            }

            var loadLayer3 = new ArcGISDynamicMapServiceLayer("http://192.168.100.195:6080/arcgis/rest/services/DLTB2017/MapServer");
            var btn3 = document.getElementById("DLTB2007");
            btn3.onclick = function() {
                if (btn3.checked) {
                    map.addLayer(loadLayer3);
                    shapeArr.push("2007");
                } else {
                    map.removeLayer(loadLayer3);
                    shapeArr.remove("2007");
                }
                toplayer();
            }

            var loadLayer4 = new ArcGISDynamicMapServiceLayer("http://192.168.100.195:6080/arcgis/rest/services/济源正射/MapServer");
            var btn4 = document.getElementById("zs");
            btn4.onclick = function() {
                if (btn4.checked) {
                    map.addLayer(loadLayer4);
                    shapeArr.push("zs");
                } else {
                    map.removeLayer(loadLayer4);
                    shapeArr.remove("zs");
                }
                toplayer();
            }

            var loadLayer5 = new ArcGISDynamicMapServiceLayer("http://192.168.100.195:6080/arcgis/rest/services/经营权_北海/MapServer");
            var btn5 = document.getElementById("jyq_bh");
            btn5.onclick = function() {
                if (btn5.checked) {
                    map.addLayer(loadLayer5);
                } else {
                    map.removeLayer(loadLayer5);
                }
            }

            var loadLayer6 = new ArcGISDynamicMapServiceLayer("http://192.168.100.195:6080/arcgis/rest/services/经营权_克井/MapServer");
            var btn6 = document.getElementById("jyq_kj");
            btn6.onclick = function() {
                if (btn6.checked) {
                    map.addLayer(loadLayer6);
                } else {
                    map.removeLayer(loadLayer6);
                }
            }
            var loadLayer7 = new ArcGISDynamicMapServiceLayer("http://192.168.100.195:6080/arcgis/rest/services/经营权_大峪/MapServer");
            var btn7 = document.getElementById("jyq_dy");
            btn7.onclick = function() {
                if (btn7.checked) {
                    map.addLayer(loadLayer7);
                } else {
                    map.removeLayer(loadLayer7);
                }
            }
            var loadLayer8 = new ArcGISDynamicMapServiceLayer("http://192.168.100.195:6080/arcgis/rest/services/经营权_承留/MapServer");
            var btn8 = document.getElementById("jyq_cl");
            btn8.onclick = function() {
                if (btn8.checked) {
                    map.addLayer(loadLayer8);
                } else {
                    map.removeLayer(loadLayer8);
                }
            }
            var loadLayer9 = new ArcGISDynamicMapServiceLayer("http://192.168.100.195:6080/arcgis/rest/services/经营权_梨林/MapServer");
            var btn9 = document.getElementById("jyq_ll");
            btn9.onclick = function() {
                if (btn9.checked) {
                    map.addLayer(loadLayer9);
                } else {
                    map.removeLayer(loadLayer9);
                }
            }
            var loadLayer10 = new ArcGISDynamicMapServiceLayer("http://192.168.100.195:6080/arcgis/rest/services/经营权_坡头/MapServer");
            var btn10 = document.getElementById("jyq_pt");
            btn10.onclick = function() {
                if (btn10.checked) {
                    map.addLayer(loadLayer10);
                } else {
                    map.removeLayer(loadLayer10);
                }
            }
            var loadLayer11 = new ArcGISDynamicMapServiceLayer("http://192.168.100.195:6080/arcgis/rest/services/经营权_沁园/MapServer");
            var btn11 = document.getElementById("jyq_qy");
            btn11.onclick = function() {
                if (btn11.checked) {
                    map.addLayer(loadLayer11);
                } else {
                    map.removeLayer(loadLayer11);
                }
            }
            var loadLayer12 = new ArcGISDynamicMapServiceLayer("http://192.168.100.195:6080/arcgis/rest/services/经营权_邵原/MapServer");
            var btn12 = document.getElementById("jyq_sy");
            btn12.onclick = function() {
                if (btn12.checked) {
                    map.addLayer(loadLayer12);
                } else {
                    map.removeLayer(loadLayer12);
                }
            }
            var loadLayer13 = new ArcGISDynamicMapServiceLayer("http://192.168.100.195:6080/arcgis/rest/services/经营权_天坛/MapServer");
            var btn13 = document.getElementById("jyq_tt");
            btn13.onclick = function() {
                if (btn13.checked) {
                    map.addLayer(loadLayer13);
                } else {
                    map.removeLayer(loadLayer13);
                }
            }
            var loadLayer14 = new ArcGISDynamicMapServiceLayer("http://192.168.100.195:6080/arcgis/rest/services/经营权_王屋/MapServer");
            var btn14 = document.getElementById("jyq_ww");
            btn14.onclick = function() {
                if (btn14.checked) {
                    map.addLayer(loadLayer14);
                } else {
                    map.removeLayer(loadLayer14);
                }
            }
            var loadLayer15 = new ArcGISDynamicMapServiceLayer("http://192.168.100.195:6080/arcgis/rest/services/经营权_下冶/MapServer");
            var btn15 = document.getElementById("jyq_xy");
            btn15.onclick = function() {
                if (btn15.checked) {
                    map.addLayer(loadLayer15);
                } else {
                    map.removeLayer(loadLayer15);
                }
            }
            var loadLayer16 = new ArcGISDynamicMapServiceLayer("http://192.168.100.195:6080/arcgis/rest/services/经营权_五龙口/MapServer");
            var btn16 = document.getElementById("jyq_wlk");
            btn16.onclick = function() {
                if (btn16.checked) {
                    map.addLayer(loadLayer16);
                } else {
                    map.removeLayer(loadLayer16);
                }
            }
            var loadLayer17 = new ArcGISDynamicMapServiceLayer("http://192.168.100.195:6080/arcgis/rest/services/经营权_轵城/MapServer");
            var btn17 = document.getElementById("jyq_zz");
            btn17.onclick = function() {
                if (btn17.checked) {
                    map.addLayer(loadLayer17);
                } else {
                    map.removeLayer(loadLayer17);
                }
            }
            var loadLayer18 = new ArcGISDynamicMapServiceLayer("http://192.168.100.195:6080/arcgis/rest/services/经营权_玉泉/MapServer");
            var btn18 = document.getElementById("jyq_yq");
            btn18.onclick = function() {
                if (btn18.checked) {
                    map.addLayer(loadLayer18);
                } else {
                    map.removeLayer(loadLayer18);
                }
            }
            var loadLayer19 = new ArcGISDynamicMapServiceLayer("http://192.168.100.195:6080/arcgis/rest/services/经营权_思礼/MapServer");
            var btn19 = document.getElementById("jyq_sl");
            btn19.onclick = function() {
                if (btn19.checked) {
                    map.addLayer(loadLayer19);
                } else {
                    map.removeLayer(loadLayer19);
                }
            }
            Array.prototype.indexOf = function(val) {
                for (var i = 0; i < this.length; i++) {
                    if (this[i] == val) return i;
                }
                return -1;
            };
            Array.prototype.remove = function(val) {
                var index = this.indexOf(val);
                if (index > -1) {
                    this.splice(index, 1);
                }
            };

            function toplayer() {
                var id = shapeArr.slice(-1);
                if (id == "2018") {
                    queryUrl = "http://192.168.100.195:6080/arcgis/rest/services/shape2018/MapServer";
                } else {
                    queryUrl = "none";
                }
                pointQueryClick();
            }

            var opacityBtn = document.getElementById("setOpacity");
            opacityBtn.onclick = function() {
                var str = document.getElementById("opacity").value;
                var id = shapeArr.slice(-1);
                if (id == "2020") {
                    loadLayer1.setOpacity(str / 100);
                } else if (id == "2018") {
                    loadLayer2.setOpacity(str / 100);
                } else if (id == "2007") {
                    loadLayer3.setOpacity(str / 100);
                } else if (id == "zs") {
                    loadLayer4.setOpacity(str / 100);
                }
            }

            var pygonBtn = document.getElementById("pygon");
            pygonBtn.onclick = function() {
                if (isanalyse) {
                    draw.activate(esri.toolbars.Draw.POLYGON);
                    shapeList.clear();
                    map.graphics.clear();
                    map.infoWindow.hide();
                }
            }

            var lineBtn = document.getElementById("line");
            lineBtn.onclick = function() {
                isline = true;
                isploygon = false;
                draw.activate(esri.toolbars.Draw.POLYLINE);
            }

            var ploygonBtn = document.getElementById("ploygon");
            ploygonBtn.onclick = function() {
                isploygon = true;
                isline = false;
                draw.activate(esri.toolbars.Draw.POLYGON);
            }

            var closeBtn = document.getElementById("close");
            closeBtn.onclick = function() {
                isline = false;
                isploygon = false;
                if (shapeList.length > 0) {
                    shapeList.clear();
                }
                map.graphics.clear();
                map.infoWindow.hide();
            }

            var outBtn = document.getElementById("putout");
            outBtn.onclick = function() {
                if (shapeList.length > 0) {
                    downloadTxt("汇总.txt", shapeList);
                }
            }

            //通过a标签指定文本格式和编码直接下载
            function downloadTxt(fileName, shapeArr) {
                let a = document.createElement('a');
                var content = "";
                for (var i = 0; i < shapeArr.length; i++) {
                    content = content + shapeArr[i] + "\n";
                }
                a.href = 'data:text/plain;charset=utf-8,' + content
                a.download = fileName
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }

            var searchBtn = document.getElementById("analyse");
            searchBtn.onclick = function() {
                if (isanalyse) {
                    isanalyse = false;
                    searchBtn.value = "开启叠加分析";
                    shapeList.clear();
                } else {
                    isanalyse = true;
                    searchBtn.value = "关闭叠加分析";
                }
                isline = false;
                isploygon = false;
            }

            draw.on("draw-complete", function(resultDraw) {
                //得到绘图图形
                var geometry = resultDraw.geometry;
                geometry.spatialReference = map.spatialReference;
                //关闭绘图工具
                draw.deactivate();

                if (isline) {
                    var lineSymbol = new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new dojo.Color([255, 0, 0]), 2);
                    var graphic = new Graphic(geometry, lineSymbol);
                    map.graphics.add(graphic);
                    var line = geometryEngine.planarLength(geometry, "meters")
                    var font = new Font("20px", Font.STYLE_NORMAL, Font.VARIANT_NORMAL,
                        Font.WEIGHT_BOLDER);
                    var textSymbol = new TextSymbol(fomatFloat(line, 2) + "米", font, new dojo.Color([0, 0, 0]));
                    textSymbol.yoffset = -12;
                    var textGraphic = new Graphic(_evt.mapPoint, textSymbol);
                    map.graphics.add(textGraphic);
                    return;
                }

                if (isploygon) {
                    //    设置总长度的显示样式，并添加到地图上
                    //创建线符号
                    var lineSymbol = new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new dojo.Color([255, 0, 0]), 2);
                    var fill = new SimpleFillSymbol(SimpleFillSymbol.NONE, lineSymbol);
                    var graphic = new Graphic(geometry, fill);
                    map.graphics.add(graphic);
                    var area = geometryEngine.planarArea(geometry, "square-meters");
                    var font = new Font("20px", Font.STYLE_NORMAL, Font.VARIANT_NORMAL,
                        Font.WEIGHT_BOLDER);
                    var textSymbol = new TextSymbol(fomatFloat(area, 2) + "平方米", font, new dojo.Color([0, 0, 0]));
                    textSymbol.yoffset = -12;
                    var textGraphic = new Graphic(_evt.mapPoint, textSymbol);
                    map.graphics.add(textGraphic);
                    return;
                }
                if (clickQuery) {
                    identifyQuery(_clickUrl, _clickIds,
                        geometry,
                        function(results, map, geometry) {
                            if (results.length > 0) {
                                // 利用hashtable进行对应的生成，获取相同名称的属性值，并放到同一个key对应的value中
                                var hashtable = new Dictionary();
                                var analyseArray = new Array();
                                var nameArray = new Array();
                                map.graphics.clear();
                                // 这里生成新的数组，获取名字相同的图层名
                                for (var i = 0; i < results.length; i++) {
                                    if (!hashtable
                                        .containsKey(results[i].layerName)) {
                                        hashtable.add(
                                            results[i].layerName, [results[i].feature]);
                                    } else {
                                        var arrayFeature = hashtable
                                            .item(results[i].layerName);
                                        arrayFeature
                                            .push(results[i].feature);
                                    }
                                    //创建线符号
                                    var lineSymbol = new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new dojo.Color([255, 125, 100]), 1);
                                    //创建面符号
                                    var fill = new SimpleFillSymbol(SimpleFillSymbol.NONE, lineSymbol);
                                    var interploy = geometryEngine.intersect(geometry, results[i].feature.geometry);
                                    var area = geometryEngine.planarArea(interploy, "square-meters")
                                        //获得图形graphicx
                                    var graphic = new Graphic(interploy, fill);
                                    map.graphics.add(graphic);
                                    var analyseFruit = {};
                                    analyseFruit.id = results[i].feature.attributes["FID"];
                                    analyseFruit.name = results[i].feature.attributes["QSDWMC"];
                                    analyseFruit.typeName = results[i].feature.attributes["DLMC"];
                                    analyseFruit.area = area;
                                    nameArray.push(results[i].feature.attributes["QSDWMC"]);
                                    analyseArray.push(analyseFruit);
                                }
                                if (_clickTree) {
                                    _clickTree.destroy();
                                }
                                handler_click_query(hashtable, _evt, analyseArray, nameArray);
                            } else {
                                alert("当前点未查询到任何元素");
                            }
                        });
                }
            });

            map.on("click", function(evt) {
                if (isanalyse || isploygon || isline) {
                    _evt = evt;
                    evtArray.push(evt);
                    return;
                }
                if (clickQuery) {
                    identifyQuery(_clickUrl, _clickIds,
                        evt.mapPoint,
                        function(results, map) {
                            if (results.length > 0) {
                                // 利用hashtable进行对应的生成，获取相同名称的属性值，并放到同一个key对应的value中
                                var hashtable = new Dictionary();
                                map.graphics.clear();
                                // 这里生成新的数组，获取名字相同的图层名
                                for (var i = 0; i < results.length; i++) {
                                    if (!hashtable
                                        .containsKey(results[i].layerName)) {
                                        hashtable.add(
                                            results[i].layerName, [results[i].feature]);
                                    } else {
                                        var arrayFeature = hashtable
                                            .item(results[i].layerName);
                                        arrayFeature
                                            .push(results[i].feature);
                                    }
                                    //创建线符号
                                    var lineSymbol = new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new dojo.Color([255, 225, 0]), 1);
                                    //创建面符号
                                    var fill = new SimpleFillSymbol(SimpleFillSymbol.NONE, lineSymbol);
                                    //获得图形graphic
                                    var graphic = results[i].feature;
                                    //设置图形的符号
                                    graphic.setSymbol(fill);
                                    map.graphics.add(graphic);
                                }
                                if (_clickTree) {
                                    _clickTree.destroy();
                                }
                                handler_click_query(hashtable, evt);
                            } else {
                                alert("当前点未查询到任何元素");
                            }
                        });
                }

            });

            /**
             * 点击查询
             */
            function pointQueryClick() {
                _clickUrl = queryUrl;
                _clickIds = [0, 1, 2];
                if (_clickUrl) {
                    clickQuery = true;
                } else {
                    clickQuery = false;
                }
                map.infoWindow.hide();
            }

            function identifyQuery(url, layerIds, geometry, bufferCallback) {
                var identifyTask = new IdentifyTask(url);
                var identifyParams = new IdentifyParameters();
                identifyParams.returnGeometry = true;
                identifyParams.tolerance = 0;
                identifyParams.layerIds = layerIds;
                identifyParams.layerOption = IdentifyParameters.LAYER_OPTION_ALL;
                identifyParams.geometry = geometry;
                identifyParams.width = map.width;
                identifyParams.height = map.height;
                identifyParams.mapExtent = map.extent;
                identifyParams.spatialReference = map.spatialReference;
                identifyTask.execute(identifyParams, lang.hitch(this,
                    function(results) {
                        if (lang.isFunction(bufferCallback)) {
                            bufferCallback(results, map, geometry);
                        }
                    }), function(err) {});
            }
            /**
             * 处理点击查询 hashtable key 为图层名称 value 为 feature数组
             */
            function handler_click_query(hashtable, evt, analyseArray, nameArray) {
                var table_tree = "<div style=\"height:280px;overflow:hidden;\"><div id=\"pointQueryResult\" style=\"padding-left:0px;overflow:visible\" > <table width=\"650\" cellpadding=\"0\" style=\"border-width: 1px;border-color: #666666;border-collapse: collapse;\"><tr><th style=\"border:1px solid #666666;\">图层列表</th><th style=\"border:1px solid #666666;\">详细信息</th><th style=\"border:1px solid #666666;\">汇总信息</th></tr><tr valign=\"top\">" +
                    "<td style=\"width:140px;height:242px;vertical-align: top;border:1px solid #666666;\">" +
                    "<div id=\"showLayerResult\" style=\"overflow:auto;width:100%;height:100%;margin:0px;padding:0px;\">";
                var treeData = [];
                hashtable.forEach(function(entry) {
                    var item = {};
                    item.id = entry.key;
                    item.name = entry.key;
                    item.type = "test";
                    item.children = [];
                    treeData.push(item);
                    for (var i = 0; i < entry.value.length; i++) {
                        var featureId = entry.value[i].attributes['FID'] ?
                            entry.value[i].attributes['FID'] :
                            entry.value[i].attributes['OBJECTID'];
                        item.children.push({
                            _reference: entry.key +
                                featureId
                        });
                        treeData.push({
                            id: entry.key + featureId,
                            name: featureId,
                            type: "feature"
                        });
                    }
                });
                var data = {
                    identifier: 'id',
                    label: 'name',
                    items: treeData
                };
                var store = new ItemFileReadStore({
                    data: data
                });
                var treeModel = new ForestStoreModel({
                    store: store,
                    query: {
                        type: "test"
                    },
                    childrenAttrs: ["children"]
                });

                table_tree += "<div id='treeThree'></div>";
                // table_tree += "</div>";
                // table_tree += "</div>";
                table_tree += "<td style=\"width:290px;height:245px;vertical-align: top;border: 1px solid #666666;\"><div style=\"overflow:auto;width:100%;height:100%;margin:0px;padding:0px;\" id='show_panel_attributes'>";
                table_tree += "<td style=\"width:290px;height:245px;vertical-align: top;border: 1px solid #666666;\"><div style=\"overflow:auto;width:100%;height:100%;margin:0px;padding:0px;\" id='show_all'>";
                map.infoWindow.setTitle("点击选择查询");
                map.infoWindow.setContent(table_tree);
                var tree = new Tree({
                    model: treeModel,
                    autoExpand: true,
                    showRoot: false
                }, "treeThree");
                tree.startup();
                tree.on("click", function(item, node, evt) {
                    04
                    // 获取当前点击的tree的id值
                    if (!node.hasChildren()) { // 判断有没有子节点
                        var selectId = item.id[0]; // 当前的objectid
                        var selectName = item.name[0];
                        var parentId = node.getParent(selectId).item.id[0]; // 图层名称
                        var featureArray = hashtable.item(parentId);
                        for (var i = 0; i < featureArray.length; i++) {
                            if (selectName == (featureArray[i].attributes['FID'] ? featureArray[i].attributes['FID'] : featureArray[i].attributes['OBJECTID'])) {
                                // 然后调用对应的单击事件方法
                                var content = _doFeatureForClickQuery(featureArray[i]);
                                domAttr.set('show_panel_attributes',
                                    'innerHTML', content);
                                break;
                            }
                        }
                    }
                });
                tree.on("load", function() {
                    var childrenArray = tree.rootNode.getChildren();
                    if (childrenArray.length > 0) {
                        var key = childrenArray[0].item.id[0];
                        var featureArray = hashtable.item(key);
                        if (featureArray.length > 0) {
                            var content = _doFeatureForClickQuery(featureArray[0]);
                            domAttr.set('show_panel_attributes', 'innerHTML', content);
                            if (isanalyse) {
                                var sList = analyseInfo(analyseArray, nameArray);
                                var aly_content = _doAnalyseForQuery(sList);
                                domAttr.set('show_all',
                                    'innerHTML', aly_content);
                            }
                        }
                    }
                });
                _clickTree = tree;
                if (isanalyse) {
                    map.infoWindow.resize(700, 360);
                    map.infoWindow.show(evt.screenPoint, map
                        .getInfoWindowAnchor(evt.screenPoint));
                } else {
                    map.infoWindow.resize(450, 360);
                    map.infoWindow.show(evt.screenPoint, map
                        .getInfoWindowAnchor(evt.screenPoint));
                }
            }

            function analyseInfo(analyseArray, nameArray) {
                var allArea = 0;
                var nA = removeDuplicatedItem(nameArray);
                for (var i = 0; i < nA.length; i++) {
                    var typeList = new Array();
                    var commonAnalyseFruits = new Array();
                    var name = "";
                    for (var a = 0; a < analyseArray.length; a++) {
                        var analyseFruit = analyseArray[a];
                        if (analyseFruit.name == nA[i]) {
                            typeList.push(analyseFruit.typeName);
                            commonAnalyseFruits.push(analyseFruit);
                            name = analyseFruit.name;
                        }
                    }
                    var tA = removeDuplicatedItem(typeList);
                    var content = "";
                    for (var j = 0; j < tA.length; j++) {
                        var area = 0;
                        var typename = "";
                        for (var b = 0; b < commonAnalyseFruits.length; b++) {
                            var analyseFruit = commonAnalyseFruits[b];
                            if (analyseFruit.typeName == tA[j]) {
                                area = area + analyseFruit.area;
                                typename = analyseFruit.typeName;
                            }
                        }
                        var m = fomatFloat(area * 0.0015, 2);
                        content = content + typename + ":" + m + "亩" + "    ";
                        allArea += area;
                    }
                    shapeList.push(name + "\n" + content);
                }
                var n = fomatFloat(allArea * 0.0015, 2);
                shapeList.push("\n" + "圈地总面积" + " : " + n + "亩");
                return shapeList;
            }

            function fomatFloat(src, pos) {
                return Math.round(src * Math.pow(10, pos)) / Math.pow(10, pos);
            }
            /**
             * 汇总信息
             */
            function _doAnalyseForQuery(shapeList) {
                var contents = "";
                contents += "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"border-collapse: collapse;\">";
                for (var i = 0; i < shapeList.length; i++) {
                    contents += "<tr>";
                    contents += "<td width=\"180\" style=\"border-bottom:1px solid #666666;border-left:1px solid #666666;border-right:1px solid #666666;padding-left:2px;\">";
                    contents += shapeList[i];
                    contents += "</td>";
                    contents += "</tr>";
                }
                contents += "</table>";
                return contents;
            }

            //数组去重
            function removeDuplicatedItem(ar) {
                var ret = [];
                for (var i = 0, j = ar.length; i < j; i++) {
                    if (ret.indexOf(ar[i]) === -1) {
                        ret.push(ar[i]);
                    }
                }
                return ret;
            }
            /**
             * 点击查询展示属性表里的所有字段
             */
            function _doFeatureForClickQuery(feature) {
                var contents = "";
                contents += "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"border-collapse: collapse;\">";
                var flag = 0;
                for (var p in feature.attributes) {
                    if (p.toString().toLowerCase().indexOf('shape') != -1 ||
                        p.toString().toLowerCase()
                        .indexOf('objectid') != -1 ||
                        p.toString().toLowerCase()
                        .indexOf('enabled') != -1)
                        continue;
                    contents += "<tr>";
                    if (flag == 0) {
                        contents += "<td height=\"20\" width=\"70\" style=\"border-bottom:1px solid #666666;border-right:1px solid #666666;text-align:right;\">";
                    } else {
                        contents += "<td height=\"20\" width=\"70\" style=\"border-top:1px solid #666666;border-bottom:1px solid #666666;border-right:1px solid #666666;text-align:right;\">";
                    }
                    contents += p;
                    contents += "</td>";
                    if (flag == 0) {
                        contents += "<td width=\"125\" style=\"border-bottom:1px solid #666666;border-left:1px solid #666666;border-right:1px solid #666666;padding-left:2px;\">";
                    } else {
                        contents += "<td width=\"125\" style=\"border:1px solid #666666;padding-left:2px;\">";
                    }
                    flag++;
                    contents += feature.attributes[p].toString()
                        .toLowerCase() == "null" ?
                        "" :
                        feature.attributes[p];
                    contents += "</td>";
                    contents += "</tr>";
                }
                contents += "</table>";
                return contents;
            }

            map.infoWindow.on("hide", function() {
                map.graphics.clear();
            });
        })
    </script>
</body>

</html>